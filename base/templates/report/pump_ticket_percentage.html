{% extends 'base.html' %}
{% load static %}
{% load basefiltertag %}
{% block title %}گزارش درصد خرابی‌های کارتخوان و صفحه‌کلید{% endblock %}
{% block context %}
<div class="main-content">
    <link rel="stylesheet" href="{% static 'vendors/datepicker/daterangepicker.css' %}">
    <script src="{% static 'assets/js/jquery-3.5.1.min.js' %}"></script>
    <link type="text/css" rel="stylesheet" href="{% static 'assets/css/jalalidatepicker.min.css' %} " />
    <script type="text/javascript" src="{% static 'assets/js/jalalidatepicker.min.js' %}"></script>
    <script src="{% static 'assets/js/tableToExcel.js' %}"></script>

    {% include 'message.html' %}

    <div class="col-lg-12 col-md-12 col-sm-12">
        <div class="card">
            <div class="card-body">
                <ul class="nav">
                    <div class="row">
                        <div class="container">
                            <div class="col-12">
                                <h3 class="c-center c-font-uppercase c-font-bold">
                                 گزارش درصد خرابی‌های کارتخوان و صفحه‌کلید
                                    <button onclick="exportToExcelWithBorders()" id="exportBtn1" style="color: #fffbff" class="btn nav-link bg-info" title="ارسال به اکسل">ارسال به اکسل</button>
                                </h3>

                                <form action="" method="post">
                                    {% csrf_token %}
                                    <hr>

                                    {% if request.user.owner.role.role in 'setad,mgr' %}
                                    <label>نام منطقه
                                        <select name="zone" onclick="$(this).select()" class="select2-example">
                                            <option value=0>همه</option>
                                            {% for zone in zones %}
                                                <option {% if selected_zone == zone.id %}selected{% endif %} value="{{ zone.id }}">{{ zone.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    {% endif %}

          <label>از تاریخ
                                        <input required data-jdp type="text" name="from_date" id="from_date" value="{{ from_date }}" class="form-control" placeholder="تاریخ شروع" autocomplete="off">
                                    </label>

                                    <label>تا تاریخ
                                        <input required data-jdp type="text" name="to_date" id="to_date" value="{{ to_date }}" class="form-control" placeholder="تاریخ پایان" autocomplete="off">
                                    </label>

                                    <label>نوع گزارش
                                        <select name="report_type" class="form-control">
                                            <option value="master" {% if report_type == 'master' %}selected{% endif %}>خرابی کارتخوان</option>
                                            <option value="pinpad" {% if report_type == 'pinpad' %}selected{% endif %}>خرابی صفحه‌کلید</option>
                                            <option value="all" {% if report_type == 'all' %}selected{% endif %}>همه موارد</option>
                                        </select>
                                    </label>

                                    <button type="submit" class="btn btn-warning c-btn-uppercase">گزارش</button>
                                </form>

                                <div class="alert alert-info alert-with-border" role="alert">

                                    این گزارش درصد خرابی‌های کارتخوان و صفحه‌کلید را نسبت به کل خرابی‌ها در هر منطقه نمایش می‌دهد.

                                </div>
                            </div>
                        </div>
                    </div>
                </ul>

                <div class="row">
                    <div class="col-lg-12">
                        <div id="responsive" class="table-responsive">
                            <table id="myTable" class="table table-bordered">
                                <caption style="display: none">گزارش درصد نازل‌های دارای تیکت</caption>
                                <thead style="background: #dbd9de; color: black">
                                    <tr>
                                        <th class="align-middle text-center text-sm" rowspan="2">#</th>
                                        <th class="align-middle text-center text-sm" rowspan="2">نام منطقه</th>
                                        <th class="align-middle text-center text-sm" colspan="{{ months|length }}">درصد  تیکت
                                            {% if report_type == 'all' %}
                                             کارتخوان و صفحه کلید
                                            {% elif report_type == 'master' %}
                                             کارتخوان
                                            {% elif report_type == 'pinpad' %}
                                             صفحه کلید
                                            {% endif %}
                                            در هر ماه</th>
                                    </tr>
                                    <tr>
                                        {% for month in months %}
                                            <th class="align-middle text-center text-sm">{{ month }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for zone_data in report_data %}
                                    <tr>
                                        <th scope="row" class="align-middle text-center text-sm">{{ forloop.counter }}</th>
                                        <td class="align-middle text-center text-sm">{{ zone_data.zone_name }}</td>
                                        {% for month_data in zone_data.months %}
                                            <td class="align-middle text-center text-sm">{{ month_data.percentage|default:"0" }}%</td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    jalaliDatepicker.startWatch();

    $('.select2-example').select2({
        placeholder: 'انتخاب کنید',
        allowClear: true
    });

    function exportToExcelWithBorders() {
        TableToExcel.convert(document.getElementById("myTable"), {
            name: "pump_ticket_percentage.xlsx",
            sheet: {
                name: "Sheet1"
            }
        });
    }
    
    $('#exportBtn1').click(exportToExcelWithBorders);
});
</script>

{% block script %}
<script src="{% static 'vendors/charts/chartjs/chart.min.js' %}"></script>
<script src="{% static 'vendors/charts/apex/apexcharts.min.js' %}"></script>
<script src="{% static 'vendors/charts/peity/jquery.peity.min.js' %}"></script>
<script src="{% static 'vendors/datepicker/daterangepicker.js' %}"></script>
{% endblock %}
{% endblock %}