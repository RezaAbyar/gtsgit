{% load static %}
{% load jformat %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --info: #36b9cc;
            --warning: #f6c23e;
            --danger: #e74a3b;
        }

        body {
            background-color: #f8f9fc;
            font-family: 'Vazir', sans-serif;
        }

        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        .kpi-card {
            border-left: 0.25rem solid;
        }

        .kpi-sales { border-left-color: var(--primary); }
        .kpi-waybills { border-left-color: var(--success); }
        .kpi-stations { border-left-color: var(--info); }
        .kpi-discrepancy { border-left-color: var(--warning); }

        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- هدر -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 text-gray-800"><i class="fas fa-tachometer-alt me-2"></i>داشبورد مدیریت</h1>
            <div class="d-flex gap-2">
                <select id="timeRange" class="form-select form-select-sm w-auto">
                    <option value="7">۷ روز گذشته</option>
                    <option value="30" selected>۳۰ روز گذشته</option>
                    <option value="90">۹۰ روز گذشته</option>
                    <option value="365">یک سال گذشته</option>
                </select>
                <select id="stationFilter" class="form-select form-select-sm w-auto">
                    <option value="">همه جایگاه‌ها</option>
                    {% for gs in gs_list %}
                    <option value="{{ gs.id }}">{{ gs.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4" id="kpi-cards">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card kpi-card kpi-sales">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    فروش کل</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-sales">0</div>
                                <div class="text-xs text-muted" id="sales-period"></div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card kpi-card kpi-waybills">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    بارنامه‌ها</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-waybills">0</div>
                                <div class="text-xs text-muted">تعداد بارنامه</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-truck fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card kpi-card kpi-stations">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    جایگاه‌های فعال</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="active-stations">0</div>
                                <div class="text-xs text-muted">تعداد جایگاه</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-gas-pump fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card kpi-card kpi-discrepancy">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    میانگین مغایرت</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="avg-discrepancy">0</div>
                                <div class="text-xs text-muted">لیتر</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- نمودارها -->
        <div class="row mb-4">
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">روند فروش روزانه</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">رتبه‌بندی جایگاه‌ها</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rankingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- جدول داده‌ها -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">آخرین فروش‌ها</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" id="recent-sales-table">
                            <!-- داده‌ها با AJAX لود می‌شوند -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تنظیمات اولیه
        let salesChart, rankingChart;
        const csrfToken = "{{ csrf_token }}";

        // لود اولیه داده‌ها
        document.addEventListener('DOMContentLoaded', function() {
            loadKPIData();
            loadSalesChart();
            loadRankingChart();

            // رویداد تغییر فیلترها
            document.getElementById('timeRange').addEventListener('change', updateDashboard);
            document.getElementById('stationFilter').addEventListener('change', updateDashboard);
        });

        function updateDashboard() {
            loadKPIData();
            loadSalesChart();
            loadRankingChart();
        }

        function loadKPIData() {
            const days = document.getElementById('timeRange').value;

            fetch(`/dashboard/api/kpi-data/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-sales').textContent = data.total_sales;
                    document.getElementById('total-waybills').textContent = data.total_waybills;
                    document.getElementById('active-stations').textContent = data.active_stations;
                    document.getElementById('avg-discrepancy').textContent = data.avg_discrepancy;
                    document.getElementById('sales-period').textContent = data.period;
                });
        }

        function loadSalesChart() {
            const days = document.getElementById('timeRange').value;
            const stationId = document.getElementById('stationFilter').value;

            let url = `/dashboard/api/sales-data/?days=${days}`;
            if (stationId) {
                url += `&gs_id=${stationId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (salesChart) {
                        salesChart.destroy();
                    }

                    const ctx = document.getElementById('salesChart').getContext('2d');
                    salesChart = new Chart(ctx, {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    rtl: true
                                }
                            },
                            scales: {
                                x: {
                                    reverse: true
                                }
                            }
                        }
                    });
                });
        }

        function loadRankingChart() {
            const days = document.getElementById('timeRange').value;

            fetch(`/dashboard/api/station-ranking/?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (rankingChart) {
                        rankingChart.destroy();
                    }

                    const labels = data.ranking.map(item => item.gs__name);
                    const salesData = data.ranking.map(item => item.total_sales);

                    const ctx = document.getElementById('rankingChart').getContext('2d');
                    rankingChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'فروش کل',
                                data: salesData,
                                backgroundColor: '#4e73df'
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                });
        }

        // رفرش خودکار هر 5 دقیقه
        setInterval(updateDashboard, 5 * 60 * 1000);
    </script>
</body>
</html>