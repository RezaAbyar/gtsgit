{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load jalali_tags %}
{% block css %}
    <style>
        thead,
        tfoot {
            background-color: #3f87a6;
            color: #fff;
        }
        .no-settlement {
            background-color: #ffcccc !important;
            color: #cc0000;
        }
        .dahe-row {
            background-color: #134236 !important;
            font-weight: bold;
            color: white;
        }
        .total-row {
            background-color: #4a86e8 !important;
            color: white;
            font-weight: bold;
        }
        @media print {
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ ØµÙØ­Ù‡ */
        @page {
            size: A4 landscape;
            margin: 10mm !important;
        }

        /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ */
        .no-print,
        button,
        .btn,
        form,
        .card-header,
        .card:not(.print-card) {
            display: none !important;
        }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø¯Ù†Ù‡ */
        body {
            font-size: 10pt !important;
            background: white !important;
            color: black !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø±Øª Ùˆ Ø¬Ø¯ÙˆÙ„ */
        .card {
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }

        .card-body {
            padding: 0 !important;
            margin: 0 !important;
        }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÙˆÙ„ */
        .table {
            width: 100% !important;
            font-size: 8pt !important;
            border-collapse: collapse !important;
        }

        .table-bordered {
            border: 1px solid black !important;
        }

        .table-bordered th,
        .table-bordered td {
            border: 1px solid black !important;
            padding: 2px 3px !important;
            line-height: 1.2 !important;
        }

        /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¯Ø± Ú†Ø§Ù¾ */
        .dahe-row,
        .total-row,
        .no-settlement,
        thead,
        tfoot {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Ù¾ÛŒØ´Ú¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† ØµÙØ­Ù‡ Ø¯Ø±ÙˆÙ† Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ */
        tr {
            page-break-inside: avoid !important;
            page-break-after: auto !important;
        }

        /* ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ */
        tr td {
            height: 20px !important;
            max-height: 20px !important;
            overflow: hidden !important;
        }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ */
        thead th {
            background-color: #3f87a6 !important;
            color: white !important;
            font-weight: bold !important;
        }

        /* Ø­ÙØ¸ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ */
        .dahe-row td {
            background-color: #134236 !important;
            color: white !important;
            font-weight: bold !important;
        }

        .total-row td {
            background-color: #4a86e8 !important;
            color: white !important;
            font-weight: bold !important;
        }

        .no-settlement td {
            background-color: #ffcccc !important;
            color: #cc0000 !important;
        }
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ÛŒ */
    .print-btn-container {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 10000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    </style>
    <script>
        $(window).load(function () {
            $(".se-pre-con").fadeOut("slow");
        });
    </script>
{% endblock %}

{% block context %}
    <link type="text/css" rel="stylesheet" href="{% static 'assets/css/jalalidatepicker.min.css' %} "/>
    <script type="text/javascript" src="{% static 'assets/js/jalalidatepicker.min.js' %}"></script>
    <script src="{% static 'assets/js/tableToExcel.js' %}"></script>

           <script src="{% static 'assets/js/jquery-3.5.1.min.js' %}"></script>


    {% include 'message.html' %}

    <div class="col-lg-12 col-md-12 col-sm-12">
        <div class="card">
            <div class="card-body">
                <h3 class="c-center c-font-uppercase c-font-bold">Ú¯Ø²Ø§Ø±Ø´ ÙØ±ÙˆØ´ Ø¯Ù‡Ù‡ Ùˆ Ù…Ø§Ù‡</h3>
                <form action="" method="post">
                    {% csrf_token %}
                    <hr>
                    <div class="row">
                        <div class="col-lg-2 col-md-6 col-sm-12">
                            <label class="form-label">Ø³Ø§Ù„</label>
                            <select name="year" id="id_year" class="form-control">
                                {% for y in years %}
                                    <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-lg-2 col-md-6 col-sm-12">
                            <label class="form-label">Ù…Ø§Ù‡</label>
                            <select name="month" id="id_month" class="form-control">
                                {% for m_num, m_name in months %}
                                    <option value="{{ m_num }}" {% if m_num == current_month %}selected{% endif %}>{{ m_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-lg-2 col-md-6 col-sm-12">
                            <label class="form-label">Ù…Ù†Ø·Ù‚Ù‡</label>
                            <select name="zone" id="id_zone" class="form-control" onchange="areainzone(this.value);">
                                <option value="0">Ù‡Ù…Ù‡ Ù…Ù†Ø§Ø·Ù‚</option>
                                {% for zone in zones %}
                                    <option value="{{ zone.id }}">{{ zone.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-lg-2 col-md-6 col-sm-12">
                            <label class="form-label">Ù†Ø§Ø­ÛŒÙ‡</label>
                            <select name="area" id="id_area" class="form-control" onchange="cityinarea(this.value);">
                                <option value="0">Ù‡Ù…Ù‡ Ù†ÙˆØ§Ø­ÛŒ</option>
                            </select>
                        </div>

                        <div class="col-lg-2 col-md-6 col-sm-12">
                            <label class="form-label">Ø¬Ø§ÛŒÚ¯Ø§Ù‡</label>
                            <select name="gs" id="id_gs" class="form-control select2">

                                {% for gs in gs_list %}
                                    <option value="{{ gs.id }}">{{ gs.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-lg-2 col-md-6 col-sm-12">
                            <label class="form-label">ÙØ±Ø¢ÙˆØ±Ø¯Ù‡</label>
                            <select name="product" id="product" class="form-control">
                                {% for product in products %}
                                    <option {% if product_id == product.id %} selected {% endif %} value="{{ product.id }}">{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-lg-12 text-center">
                            <button type="submit" class="btn btn-warning c-btn-uppercase">Ú¯Ø²Ø§Ø±Ø´</button>
                            <a onclick="exportToExcelWithBorders()" id="exportBtn1" style="color: #fffbff" class="btn nav-link bg-info" title="Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ú©Ø³Ù„ ">
                                <i data-feather="send" aria-hidden="true"></i>Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ú©Ø³Ù„
                            </a>

                        </div>
                    </div>
                </form>

                {% if rep %}
                <div class="mt-4">
                   <div class="table-responsive">
                    <table class="table table-bordered" id="exportTable">
                        <thead>
                            <tr>
                                <td style="background: #0b0b0b" class="text-center" colspan="10">{{ rep }}</td>
                            </tr>
                            <tr>
                                <td>Ú©Ø¯ Ø¬Ø§ÛŒÚ¯Ø§Ù‡</td>
                                <td>Ù†Ø§Ù… Ø¬Ø§ÛŒÚ¯Ø§Ù‡</td>
                                <td>ØªØ§Ø±ÛŒØ® / Ø¯ÙˆØ±Ù‡</td>
                                <td>Ù†Ø±Ø® 1</td>
                                <td>Ù†Ø±Ø® 2</td>
                                <td>Ù†Ø±Ø® 3</td>
                                <td>ÙØ±ÙˆØ´ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ</td>
                                <td>ÙØ±ÙˆØ´ Ù…Ú©Ø§Ù†ÛŒÚ©ÛŒ</td>
                                <td>Ø§Ø®ØªÙ„Ø§Ù</td>
                                <td>ØªÙˆØ¶ÛŒØ­Ø§Øª</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in list %}
                                <tr  class="{% if item.isdahe and item.tarikh == 'Ø¬Ù…Ø¹ Ú©Ù„ Ù…Ø§Ù‡' %}total-row{% elif item.isdahe %} dahe-row{% elif item.no_settlement %}no-settlement{% endif %}">
                                    {% if item.isdahe %}
                                        <td class="text-center" colspan="3"><strong>{{ item.tarikh }}</strong></td>
                                    {% else %}
                                        <td>{{ item.gsid }}</td>
                                        <td>{{ item.name }}</td>
                                        <td>
                                            {% if item.no_settlement %}
                                                <span style="color: #cc0000;">Ø¹Ø¯Ù… ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨ - {{ item.tarikh|to_jalali:'%Y/%m/%d' }}</span>
                                            {% else %}
                                                {{ item.tarikh|to_jalali:'%Y/%m/%d' }}
                                                {% if item.h_date %}
                                                <span style="color: #749435;">({{ item.h_date }})</span>
                                                    {% endif %}
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                    <td>{{ item.n1|floatformat:0 }}</td>
                                    <td>{{ item.n2|floatformat:0 }}</td>
                                    <td>{{ item.n3|floatformat:0 }}</td>
                                    <td>{{ item.sell|floatformat:0 }}</td>
                                    <td>{{ item.mek|floatformat:0 }}</td>
                                    <td>{{ item.ekhtelaf|floatformat:0 }}</td>
                                    <td>
                                        {% if not item.isdahe %}
                                            {% if item.accept_for_buy_exists %}
                                                <span style="color: #ff6600;">Ø§Ø¹Ù„Ø§Ù… Ù…ØºØ§ÛŒØ±Øª</span>
                                            {% endif %}
                                             {% if item.hardcrash_exists %}
                                                <span style="color: #749435;">Ø«Ø¨Øª ÙØ±ÙˆØ´ ØªØ¹ÙˆÛŒØ¶ Ù‡Ø§Ø±Ø¯</span>

                                            {% endif %}
                                            {% if item.change_miter %}
                                                <span style="color: #ab1c58;">ØªØ¹ÙˆÛŒØ¶ ØªÙˆØªØ§Ù„Ø§ÛŒØ²Ø±</span>
                                            {% endif %}
                                            {% if item.close_gs_exists %}
                                                {% if item.accept_for_buy_exists %}<br>{% endif %}
                                                <span style="color: #0066cc;">ØªØ¹Ø·ÛŒÙ„ÛŒ/ØªØ¹ÙˆÛŒØ¶ Ù‡Ø§Ø±Ø¯</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
<script>
function printReportSimple() {
    // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù¾Ù†Ø¬Ø±Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾
    var printWindow = window.open('', '_blank');

    // Ù…Ø­ØªÙˆØ§ÛŒ HTML Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾
    var printContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="fa">
        <head>
            <meta charset="UTF-8">
            <title>Ú¯Ø²Ø§Ø±Ø´ ÙØ±ÙˆØ´ Ø¯Ù‡Ù‡</title>
            <style>
                @page {
                    size: A4 landscape;
                    margin: 10mm;
                }
                body {
                    font-family: Tahoma, Arial, sans-serif;
                    font-size: 9pt;
                    direction: rtl;
                    margin: 0;
                    padding: 0;
                }
                .print-table {
                    width: 100%;
                    border-collapse: collapse;
                    border: 1px solid #000;
                }
                .print-table th, .print-table td {
                    border: 1px solid #000;
                    padding: 3px 5px;
                    text-align: center;
                    vertical-align: middle;
                }
                .print-table thead th {
                    background-color: #3f87a6;
                    color: white;
                    font-weight: bold;
                }
                .dahe-row td {
                    background-color: #134236 !important;
                    color: white !important;
                    font-weight: bold !important;
                }
                .total-row td {
                    background-color: #4a86e8 !important;
                    color: white !important;
                    font-weight: bold !important;
                }
                .no-settlement td {
                    background-color: #ffcccc !important;
                    color: #cc0000 !important;
                }
                .report-title {
                    text-align: center;
                    font-size: 14pt;
                    font-weight: bold;
                    margin: 10px 0;
                }
            </style>
        </head>
        <body>
            <div class="report-title">${$('h3.c-center').text()}</div>
            ${document.getElementById('exportTable').outerHTML}
        </body>
        </html>
    `;

    // Ù†ÙˆØ´ØªÙ† Ù…Ø­ØªÙˆØ§ Ø¯Ø± Ù¾Ù†Ø¬Ø±Ù‡ Ø¬Ø¯ÛŒØ¯
    printWindow.document.write(printContent);
    printWindow.document.close();

    // Ú†Ø§Ù¾ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    };
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡
$(document).ready(function() {
    if ($('#exportTable').length) {
        $('body').append(`
            <div class="no-print" style="position: fixed; top: 10px; left: 10px; z-index: 10000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                <button class="btn btn-success" onclick="printReportSimple()" style="padding: 10px 20px; font-size: 14px;">
                    ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª Ú¯Ø²Ø§Ø±Ø´
                </button>
            </div>
        `);
    }
});
</script>
<script>
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Select2 Ø¨Ø±Ø§ÛŒ Ø¬Ø§ÛŒÚ¯Ø§Ù‡
        $(document).ready(function() {
            $('#id_gs').select2({
                placeholder: "Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ø§ÛŒÚ¯Ø§Ù‡",
                allowClear: true,
                language: "fa",
                width: '100%'
            });
        });
    </script>
    {% include 'script_sell.html' %}

{% endblock %}

{% block scripts %}
    <script>

        function exportToExcelWithBorders() {
            var table = document.getElementById("exportTable");
            TableToExcel.convert(table, {
                name: "Ú¯Ø²Ø§Ø±Ø´_ÙØ±ÙˆØ´_Ø¯Ù‡Ù‡.xlsx",
                sheet: {
                    name: "Sheet 1"
                }
            });
        }
    </script>
{% endblock %}