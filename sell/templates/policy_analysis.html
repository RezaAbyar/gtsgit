<!-- templates/policy_analysis.html -->
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù„ÛŒÙ„ ØªØ£Ø«ÛŒØ± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ù</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-item { flex: 1; min-width: 200px; }
        select, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .metric-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .chart-container { height: 400px; margin-bottom: 20px; }
        .anomaly-list { max-height: 400px; overflow-y: auto; }
        .anomaly-item { padding: 10px; border-bottom: 1px solid #eee; }
        .anomaly-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ØªØ­Ù„ÛŒÙ„ ØªØ£Ø«ÛŒØ± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ù</h1>

        <div class="card">
            <div class="filters">
                <div class="filter-item">
                    <label>Ø³ÛŒØ§Ø³Øª:</label>
                    <select id="policy-select">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÛŒØ§Ø³Øª</option>
                        {% for policy in policies %}
                            <option value="{{ policy.id }}">{{ policy.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-item">
                    <label>Ø¯ÙˆØ±Ù‡ Ù…Ù‚Ø§ÛŒØ³Ù‡:</label>
                    <select id="comparison-days">
                        <option value="30">30 Ø±ÙˆØ²</option>
                        <option value="60">60 Ø±ÙˆØ²</option>
                        <option value="90">90 Ø±ÙˆØ²</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>&nbsp;</label>
                    <button onclick="loadAnalysis()">ğŸ” ØªØ­Ù„ÛŒÙ„ Ú©Ù†</button>
                </div>
            </div>
        </div>

        <div id="loading" style="display: none; text-align: center; padding: 20px;">
            <div>Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...</div>
        </div>

        <div id="results" style="display: none;">
            <!-- Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ -->
            <div class="card">
                <h2>ğŸ“ˆ Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ ØªØ£Ø«ÛŒØ±</h2>
                <div class="metrics-grid" id="impact-metrics"></div>
            </div>

            <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ -->
            <div class="card">
                <h2>ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± Ø±ÙˆÙ†Ø¯ ÙØ±ÙˆØ´</h2>
                <div class="chart-container">
                    <canvas id="sales-trend-chart"></canvas>
                </div>
            </div>

            <!-- Ø¢Ù†ÙˆÙ…Ø§Ù„ÛŒâ€ŒÙ‡Ø§ -->
            <div class="card">
                <h2>âš ï¸ Ø±ÙØªØ§Ø±Ù‡Ø§ÛŒ ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ</h2>
                <div id="anomalies-list" class="anomaly-list"></div>
            </div>

            <!-- ØªØºÛŒÛŒØ± Ø§Ù„Ú¯ÙˆÛŒ Ù…ØµØ±Ù -->
            <div class="card">
                <h2>ğŸ”„ ØªØºÛŒÛŒØ± Ø§Ù„Ú¯ÙˆÛŒ Ù…ØµØ±Ù</h2>
                <div id="consumption-pattern"></div>
            </div>
        </div>
    </div>

    <script>
        async function loadAnalysis() {
            const policyId = document.getElementById('policy-select').value;
            const comparisonDays = document.getElementById('comparison-days').value;

            if (!policyId) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø³ÛŒØ§Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ
                const response = await fetch(`/sell/policy-analysis/${policyId}/?days=${comparisonDays}`);
                const analysis = await response.json();

                // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
                displayImpactMetrics(analysis.sales_impact);
                displayAnomalies(analysis.anomalies);
                displayConsumptionPattern(analysis.consumption_pattern);

                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
                await loadChartData(policyId);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§',error);
            }
        }

        function displayImpactMetrics(metrics) {
            const container = document.getElementById('impact-metrics');
            container.innerHTML = `
                <div class="metric-card">
                    <div>ØªØºÛŒÛŒØ± Ú©Ù„ ÙØ±ÙˆØ´</div>
                    <div class="metric-value ${metrics.total_change >= 0 ? 'positive' : 'negative'}">
                        ${metrics.total_change}%
                    </div>
                    <div>${metrics.total_change >= 0 ? 'ğŸ“ˆ Ø§ÙØ²Ø§ÛŒØ´' : 'ğŸ“‰ Ú©Ø§Ù‡Ø´'}</div>
                </div>
                <div class="metric-card">
                    <div>ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
                    <div class="metric-value ${metrics.transaction_change >= 0 ? 'positive' : 'negative'}">
                        ${metrics.transaction_change}%
                    </div>
                    <div>${metrics.transaction_change >= 0 ? 'â†—ï¸ Ø§ÙØ²Ø§ÛŒØ´' : 'â†˜ï¸ Ú©Ø§Ù‡Ø´'}</div>
                </div>
                <div class="metric-card">
                    <div>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‡Ø± ØªØ±Ø§Ú©Ù†Ø´</div>
                    <div class="metric-value ${metrics.avg_transaction_change >= 0 ? 'positive' : 'negative'}">
                        ${metrics.avg_transaction_change}%
                    </div>
                    <div>${metrics.avg_transaction_change >= 0 ? 'â¬†ï¸ Ø§ÙØ²Ø§ÛŒØ´' : 'â¬‡ï¸ Ú©Ø§Ù‡Ø´'}</div>
                </div>
            `;
        }

        function displayAnomalies(anomalies) {
            const container = document.getElementById('anomalies-list');

            let html = '<h3>Ø¬Ø§ÛŒÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØªØºÛŒÛŒØ±</h3>';
            anomalies.unusual_gs_changes.forEach(gs => {
                html += `
                    <div class="anomaly-item">
                        <strong>${gs.gs_name}</strong><br>
                        ØªØºÛŒÛŒØ±: <span class="${gs.change_percent < 0 ? 'negative' : 'positive'}">${gs.change_percent}%</span> |
                        Ù‚Ø¨Ù„: ${gs.sales_before.toLocaleString()} |
                        Ø¨Ø¹Ø¯: ${gs.sales_after.toLocaleString()}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ùˆ ...
    </script>
</body>
</html>